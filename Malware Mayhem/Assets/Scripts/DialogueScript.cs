using System.Collections;
using System.Collections.Generic;
using UnityEngine;
using TMPro;
using UnityEngine.SceneManagement;

public class DialogueScript : MonoBehaviour
{
    public TextMeshProUGUI textComponent;
    public string[] lines;
    public string[] character;
    public float textSpd;

    private List<int> questionSceneIndices = new List<int> { 6, 11, 15, 19, 23, 27, 31, 35, 39, 42}; 
                                                                                                            
    GameObject Cybe;
    GameObject Arxiu;
    GameObject Neos;
    GameObject Kernel;
    GameObject Trojan;

    public int index;
   
    [SerializeField]
    private playerDataSo playerDataSo;

    public PlayerController playerController;
    public levelSelect levelSelect;
    public bool isDialoguePaused = false;
    
    public bool isDialogueDone = false;
    // Start is called before the first frame update
    void Start()
    {
        Cybe = GameObject.Find("C");
        Arxiu = GameObject.Find("Arxiu");
        Neos = GameObject.Find("Neos");
        Kernel = GameObject.Find("Kernel");
        Trojan = GameObject.Find("Trojan");
        Cybe.SetActive(false);
        Time.timeScale = 0;
        textComponent.text = string.Empty;
        StartDialogue();
    }

    // Update is called once per frame
    void Update()
    {
        if (!playerController.isPaused)
        {
            if (Input.GetMouseButtonDown(0))
            {
                if (textComponent.text == lines[index])
                {
                    nextLine();
                    
                }
                else
                {

                    StopAllCoroutines();
                    textComponent.text = lines[index];

                }
            }
        }
       
    }

    void StartDialogue()
    {
        if (!playerController.isPaused)
        {
            isDialoguePaused = false;
            index = 0;
            StartCoroutine(currDialogue());
        }
        
    }

  
    public IEnumerator currDialogue()
    {
        switch (character[index]){
            case "Cybe":
                Arxiu.SetActive(false);
                Neos.SetActive(false);
                Kernel.SetActive(false);
                Trojan.SetActive(false);
                Cybe.SetActive(true); break;
            case "Arxiu":
                Cybe.SetActive(false);
                Neos.SetActive(false);
                Kernel.SetActive(false);
                Trojan.SetActive(false);
                Arxiu.SetActive(true); break;
            case "Neos":
                Arxiu.SetActive(false);
                Cybe.SetActive(false);
                Kernel.SetActive(false);
                Trojan.SetActive(false);
                Neos.SetActive(true); break;
            case "Kernel":
                Arxiu.SetActive(false);
                Cybe.SetActive(false);
                Neos.SetActive(false);
                Trojan.SetActive(false);
                Kernel.SetActive(true); break;
            case "Trojan":
                Arxiu.SetActive(false);
                Cybe.SetActive(false);
                Neos.SetActive(false);
                Kernel.SetActive(false);
                Trojan.SetActive(true); break;
            case "NA":
                Arxiu.SetActive(false);
                Cybe.SetActive(false);
                Neos.SetActive(false);
                Kernel.SetActive(false);
                Trojan.SetActive(false);
                break;
        }

        foreach(char c in lines[index].ToCharArray())
        {
            
            while (isDialoguePaused)
            {
                yield return null;
            }
            
            textComponent.text += c;
            yield return new WaitForSecondsRealtime(textSpd);
        }
        

    }
    void nextLine()
    {
        if (index < lines.Length-1)
        {
            isDialogueDone = false;
            index++;
            textComponent.text = string.Empty;
            StartCoroutine(currDialogue());
        }
        else
        {
            

            int currentSceneIndex = SceneManager.GetActiveScene().buildIndex;

            if (!questionSceneIndices.Contains(currentSceneIndex))
            {
                gameObject.SetActive(false);
                
            }

            isDialogueDone = true;
            Time.timeScale = 1;

            if (questionSceneIndices.Contains(currentSceneIndex))
            {
                // Load the lobby scene
                playerDataSo.healthPoint = playerDataSo.maxHealthPoint; // reset hp
                playerDataSo.playerLifeCount = playerDataSo.maxLifePoint; // reset life count
                playerDataSo.coinAmount += playerDataSo.currentCollectedCoin; // update coin count
                playerDataSo.currentCollectedCoin = 0; // reset coin collected

               
                if(playerDataSo.currentLevel == playerDataSo.levelUnlock)
                {
                    playerDataSo.levelUnlock += 1;
                    StartCoroutine(Main.Instance.Web.Save(playerDataSo.levelUnlock, playerDataSo.coinAmount, playerDataSo.healCounter));
                }
                else
                {
                    StartCoroutine(Main.Instance.Web.Save(playerDataSo.levelUnlock, playerDataSo.coinAmount, playerDataSo.healCounter));
                }
                
                
                int lobbySceneIndex = 7; 
                SceneManager.LoadScene(lobbySceneIndex);
                
            } 
            else if (currentSceneIndex == 2)
            {
                SceneManager.LoadScene(3); 
            }
            else if (currentSceneIndex == 41)
            {
                SceneManager.LoadScene(42);
            }

        }
    }
}
