using System.Collections;
using System.Collections.Generic;
using UnityEngine;
using TMPro;
using UnityEngine.SceneManagement;

public class DialogueScript : MonoBehaviour
{
    public TextMeshProUGUI textComponent;
    public string[] lines;
    public string[] character;
    public float textSpd;

    private List<int> questionSceneIndices = new List<int> { 5, 10, 14, 18, 22, 26, 30, 34, 38}; 
                                                                                                            
    GameObject Cybe;
    GameObject Arxiu;
    GameObject Neos;
    GameObject Kernel;
    GameObject Trojan;

    public int index;

    [SerializeField]
    private playerDataSo playerDataSo;

    public PlayerController playerController;
    public bool isDialoguePaused = false;

    public bool isDialogueDone = false;
    // Start is called before the first frame update
    void Start()
    {
        Cybe = GameObject.Find("C");
        Arxiu = GameObject.Find("Arxiu");
        Neos = GameObject.Find("Neos");
        Kernel = GameObject.Find("Kernel");
        Trojan = GameObject.Find("Trojan");
        Cybe.SetActive(false);
        Time.timeScale = 0;
        textComponent.text = string.Empty;
        StartDialogue();
    }

    // Update is called once per frame
    void Update()
    {
        if (!playerController.isPaused)
        {
            if (Input.GetMouseButtonDown(0))
            {
                if (textComponent.text == lines[index])
                {
                    nextLine();
                    
                }
                else
                {

                    StopAllCoroutines();
                    textComponent.text = lines[index];

                }
            }
        }
       
    }

    void StartDialogue()
    {
        if (!playerController.isPaused)
        {
            isDialoguePaused = false;
            index = 0;
            StartCoroutine(currDialogue());
        }
        
    }

  
    public IEnumerator currDialogue()
    {
        switch (character[index]){
            case "Cybe":
                Arxiu.SetActive(false);
                Neos.SetActive(false);
                Kernel.SetActive(false);
                Trojan.SetActive(false);
                Cybe.SetActive(true); break;
            case "Arxiu":
                Cybe.SetActive(false);
                Neos.SetActive(false);
                Kernel.SetActive(false);
                Trojan.SetActive(false);
                Arxiu.SetActive(true); break;
            case "Neos":
                Arxiu.SetActive(false);
                Cybe.SetActive(false);
                Kernel.SetActive(false);
                Trojan.SetActive(false);
                Neos.SetActive(true); break;
            case "Kernel":
                Arxiu.SetActive(false);
                Cybe.SetActive(false);
                Neos.SetActive(false);
                Trojan.SetActive(false);
                Kernel.SetActive(true); break;
            case "Trojan":
                Arxiu.SetActive(false);
                Cybe.SetActive(false);
                Neos.SetActive(false);
                Kernel.SetActive(false);
                Trojan.SetActive(true); break;
            case "NA":
                Arxiu.SetActive(false);
                Cybe.SetActive(false);
                Neos.SetActive(false);
                Kernel.SetActive(false);
                Trojan.SetActive(false);
                break;
        }

        foreach(char c in lines[index].ToCharArray())
        {
            
            while (isDialoguePaused)
            {
                yield return null;
            }
            
            textComponent.text += c;
            yield return new WaitForSecondsRealtime(textSpd);
        }
        

    }
    void nextLine()
    {
        if (index < lines.Length-1)
        {
            isDialogueDone = false;
            index++;
            textComponent.text = string.Empty;
            StartCoroutine(currDialogue());
        }
        else
        {
            gameObject.SetActive(false);
            isDialogueDone = true;
            Time.timeScale = 1;

            int currentSceneIndex = SceneManager.GetActiveScene().buildIndex;

            if (questionSceneIndices.Contains(currentSceneIndex))
            {
                // Load the lobby scene
                playerDataSo.healthPoint = playerDataSo.maxHealthPoint;
                playerDataSo.playerLifeCount = playerDataSo.maxLifePoint;
                playerDataSo.coinAmount = playerDataSo.currentCollectedCoin;
                playerDataSo.currentCollectedCoin = 0;
                int lobbySceneIndex = 6; 
                SceneManager.LoadScene(lobbySceneIndex);
                
            } 
            else if (currentSceneIndex == 1)
            {
                SceneManager.LoadScene(2); 
            }

        }
    }
}
